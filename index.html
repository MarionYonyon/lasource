<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mandala Semaine</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <h1>Mandala Semaine</h1>

    <!-- Monday Section -->
    <section class="day" id="monday">
      <h2>LUNDI</h2>
      <label for="topicMonday">Sujet du zoom:</label><br />
      <input type="text" id="topicMonday" name="topicMonday" /><br />
      <label for="timeZoneMonday">Horaire FR:</label><br />
      <input
        type="time"
        id="timeZoneMonday"
        name="timeZoneMonday"
        min="00:00"
        max="23:59"
      /><br />
      <label for="animatorMonday">Qui anime le zoom:</label><br />
      <select id="animatorMonday" name="animatorMonday">
        <option value="Mathilde">Mathilde</option>
        <option value="Marion">Marion</option>
        <option value="Virginie">Virginie</option>
        <option value="Isabelle">Isabelle</option>
        <option value="Duong">Thuy Duong</option>
        <!-- 
          <option value="Camille">Camille</option>
          <option value="Morgane">Morgane</option>
          !--></select
      ><br /><br />
    </section>

    <!-- Tuesday Section -->
    <section class="day" id="tuesday">
      <h2>MARDI</h2>
      <label for="topicTuesday">Sujet du zoom:</label><br />
      <input type="text" id="topicTuesday" name="topicTuesday" /><br />
      <label for="timeZoneTuesday">Horaire FR:</label><br />
      <input
        type="time"
        id="timeZoneTuesday"
        name="timeZoneTuesday"
        min="00:00"
        max="23:59"
      /><br />
      <label for="animatorTuesday">Qui anime le zoom:</label><br />
      <select id="animatorTuesday" name="animatorTuesday">
        <option value="Mathilde">Mathilde</option>
        <option value="Marion">Marion</option>
        <option value="Virginie">Virginie</option>
        <option value="Isabelle">Isabelle</option>
        <option value="Duong">Thuy Duong</option>
        <!-- 
          <option value="Camille">Camille</option>
          <option value="Morgane">Morgane</option>
          !--></select
      ><br /><br />
    </section>

    <!-- Wednesday Section -->
    <section class="day" id="wednesday">
      <h2>MERCREDI</h2>
      <label for="topicWednesday">Sujet du zoom:</label><br />
      <input type="text" id="topicWednesday" name="topicWednesday" /><br />
      <label for="timeZoneWednesday">Horaire FR:</label><br />
      <input
        type="time"
        id="timeZoneWednesday"
        name="timeZoneWednesday"
        min="00:00"
        max="23:59"
      /><br />
      <label for="animatorWednesday">Qui anime le zoom:</label><br />
      <select id="animatorWednesday" name="animatorWednesday">
        <option value="Mathilde">Mathilde</option>
        <option value="Marion">Marion</option>
        <option value="Virginie">Virginie</option>
        <option value="Isabelle">Isabelle</option>
        <option value="Duong">Thuy Duong</option>
        <!-- 
          <option value="Camille">Camille</option>
          <option value="Morgane">Morgane</option>
          !--></select
      ><br /><br />
    </section>

    <!-- Thursday Section -->
    <section class="day" id="thursday">
      <h2>JEUDI</h2>
      <label for="topicThursday">Sujet du zoom:</label><br />
      <input type="text" id="topicThursday" name="topicThursday" /><br />
      <label for="timeZoneThursday">Horaire FR:</label><br />
      <input
        type="time"
        id="timeZoneThursday"
        name="timeZoneThursday"
        min="00:00"
        max="23:59"
      /><br />
      <label for="animatorThursday">Qui anime le zoom:</label><br />
      <select id="animatorThursday" name="animatorThursday">
        <option value="Mathilde">Mathilde</option>
        <option value="Marion">Marion</option>
        <option value="Virginie">Virginie</option>
        <option value="Isabelle">Isabelle</option>
        <option value="Duong">Thuy Duong</option>
        <!-- 
          <option value="Camille">Camille</option>
          <option value="Morgane">Morgane</option>
          !--></select
      ><br /><br />
    </section>

    <!-- Friday Section -->
    <section class="day" id="friday">
      <h2>VENDREDI</h2>
      <label for="topicFriday">Sujet du zoom:</label><br />
      <input type="text" id="topicFriday" name="topicFriday" /><br />
      <label for="timeZoneFriday">Horaire FR:</label><br />
      <input
        type="time"
        id="timeZoneFriday"
        name="timeZoneFriday"
        min="00:00"
        max="23:59"
      /><br />
      <label for="animatorFriday">Qui anime le zoom:</label><br />
      <select id="animatorFriday" name="animatorFriday">
        <option value="Mathilde">Mathilde</option>
        <option value="Marion">Marion</option>
        <option value="Virginie">Virginie</option>
        <option value="Isabelle">Isabelle</option>
        <option value="Duong">Thuy Duong</option>
        <!-- 
          <option value="Camille">Camille</option>
          <option value="Morgane">Morgane</option>
          !--></select
      ><br /><br />
    </section>

    <!-- Submit button -->
    <input type="submit" value="Submit" />

    <script src="script.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        let existingData = {};
        let topicsChanged = false;

        try {
          // Fetch data from the server
          const response = await fetch(
            "https://lasource.onrender.com/get-data"
          );
          const data = await response.json();

          // Object to map day names to section IDs
          const dayMapping = {
            Monday: "monday",
            Tuesday: "tuesday",
            Wednesday: "wednesday",
            Thursday: "thursday",
            Friday: "friday",
          };

          // Loop through the fetched data and update the corresponding fields
          data.forEach((entry) => {
            const dayId = dayMapping[entry.day]; // Get the corresponding section ID
            if (dayId) {
              const dayCapitalize =
                dayId.charAt(0).toUpperCase() + dayId.slice(1);
              // Update the input fields with the fetched data
              document.getElementById(`topic${dayCapitalize}`).value =
                entry.topic;
              document.getElementById(`timeZone${dayCapitalize}`).value =
                entry.timeZone;
              document.getElementById(`animator${dayCapitalize}`).value =
                entry.animator;

              // Store existing data for comparison
              existingData[dayId] = {
                topic: entry.topic,
                timeZone: entry.timeZone,
                animator: entry.animator,
              };
            }
          });

          // Add change listeners to topic inputs to track changes
          Object.keys(dayMapping).forEach((day) => {
            const dayId = dayMapping[day];
            const dayCapitalize =
              dayId.charAt(0).toUpperCase() + dayId.slice(1);
            document
              .getElementById(`topic${dayCapitalize}`)
              .addEventListener("input", () => {
                topicsChanged = true;
              });
          });
        } catch (error) {
          // Log any errors that occur during the fetch operation
          console.error("Error fetching entries:", error);
        }

        // Handle the submit button click
        document
          .getElementById("submit")
          .addEventListener("click", async function () {
            let dataChanged = false;

            // Check if any data has changed
            Object.keys(existingData).forEach((dayId) => {
              const dayCapitalize =
                dayId.charAt(0).toUpperCase() + dayId.slice(1);
              if (
                document.getElementById(`topic${dayCapitalize}`).value !==
                  existingData[dayId].topic ||
                document.getElementById(`timeZone${dayCapitalize}`).value !==
                  existingData[dayId].timeZone ||
                document.getElementById(`animator${dayCapitalize}`).value !==
                  existingData[dayId].animator
              ) {
                dataChanged = true;
              }
            });

            // If data has changed, submit the form
            if (dataChanged) {
              // Prepare the data to be submitted
              const updatedData = Object.keys(dayMapping).map((day) => {
                const dayId = dayMapping[day];
                const dayCapitalize =
                  dayId.charAt(0).toUpperCase() + dayId.slice(1);
                return {
                  day: day,
                  topic: document.getElementById(`topic${dayCapitalize}`).value,
                  timeZone: document.getElementById(`timeZone${dayCapitalize}`)
                    .value,
                  animator: document.getElementById(`animator${dayCapitalize}`)
                    .value,
                };
              });

              try {
                // Fetch emojis only if topics have changed
                if (topicsChanged) {
                  for (const entry of updatedData) {
                    const response = await fetch(
                      "https://lasource.onrender.com/fetch-emoji",
                      {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ topic: entry.topic }),
                      }
                    );
                    const result = await response.json();
                    entry.emoji = result.emoji;
                  }
                }

                // Send the updated data to the server
                await fetch("https://lasource.onrender.com/save-data", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(updatedData),
                });

                // Optionally, handle the response and update the UI accordingly
              } catch (error) {
                // Log any errors that occur during the submit operation
                console.error("Error saving entries:", error);
              }
            } else {
              console.log("No data changed, form not submitted.");
            }
          });
      });
    </script>
  </body>
</html>
